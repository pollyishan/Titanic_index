import streamlit as st
import pandas as pd
from pathlib import Path

st.set_page_config(page_title="–í—ã–∂–∏–ª–∏ –±—ã –≤—ã –¢–∏—Ç–∞–Ω–∏–∫–µ?", page_icon="üö¢", layout="centered")

# –ü–æ–∫–∞–∑–∞—Ç—å –ª–∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
SHOW_TESTS = False

@st.cache_data
def load_data() -> pd.DataFrame:
    csv_path = Path(__file__).with_name("model.csv")
    if csv_path.exists():
        df = pd.read_csv(csv_path, encoding="utf-8")
    else:
        DATA = [
            ("–î–µ—Ç–∏","0-18",1,0.714), ("–î–µ—Ç–∏","0-18",2,0.793), ("–î–µ—Ç–∏","0-18",3,0.364),
            ("–ñ–µ–Ω—â–∏–Ω—ã","18-25",1,1.000), ("–ñ–µ–Ω—â–∏–Ω—ã","18-25",2,0.962), ("–ñ–µ–Ω—â–∏–Ω—ã","18-25",3,0.708),
            ("–ñ–µ–Ω—â–∏–Ω—ã","25-35",1,0.958), ("–ñ–µ–Ω—â–∏–Ω—ã","25-35",2,0.941), ("–ñ–µ–Ω—â–∏–Ω—ã","25-35",3,0.435),
            ("–ñ–µ–Ω—â–∏–Ω—ã","35-45",1,1.000), ("–ñ–µ–Ω—â–∏–Ω—ã","35-45",2,0.846), ("–ñ–µ–Ω—â–∏–Ω—ã","35-45",3,0.563),
            ("–ñ–µ–Ω—â–∏–Ω—ã","45-55",1,0.962), ("–ñ–µ–Ω—â–∏–Ω—ã","45-55",2,1.000), ("–ñ–µ–Ω—â–∏–Ω—ã","45-55",3,0.375),
            ("–ñ–µ–Ω—â–∏–Ω—ã","55+",1,1.000), ("–ñ–µ–Ω—â–∏–Ω—ã","55+",2,0.667), ("–ñ–µ–Ω—â–∏–Ω—ã","55+",3,0.063),
            ("–ú—É–∂—á–∏–Ω—ã","18-25",1,0.083), ("–ú—É–∂—á–∏–Ω—ã","18-25",2,0.029), ("–ú—É–∂—á–∏–Ω—ã","18-25",3,0.074),
            ("–ú—É–∂—á–∏–Ω—ã","25-35",1,0.367), ("–ú—É–∂—á–∏–Ω—ã","25-35",2,0.053), ("–ú—É–∂—á–∏–Ω—ã","25-35",3,0.149),
            ("–ú—É–∂—á–∏–Ω—ã","35-45",1,0.364), ("–ú—É–∂—á–∏–Ω—ã","35-45",2,0.036), ("–ú—É–∂—á–∏–Ω—ã","35-45",3,0.042),
            ("–ú—É–∂—á–∏–Ω—ã","45-55",1,0.220), ("–ú—É–∂—á–∏–Ω—ã","45-55",2,0.000), ("–ú—É–∂—á–∏–Ω—ã","45-55",3,0.083),
            ("–ú—É–∂—á–∏–Ω—ã","55+",1,0.107), ("–ú—É–∂—á–∏–Ω—ã","55+",2,0.100), ("–ú—É–∂—á–∏–Ω—ã","55+",3,0.000),
        ]
        df = pd.DataFrame(DATA, columns=["Cohort","AgeBand","Class","SurvivalCoef"])
    df["Class"] = df["Class"].astype(int)
    df["SurvivalCoef"] = df["SurvivalCoef"].astype(float)
    return df

df = load_data()

def age_band(age: float) -> str:
    # 0‚Äì17, 18‚Äì25, 26‚Äì35, 36‚Äì45, 46‚Äì55, 56+
    if age < 18:
        return "0-18"      # –¥–µ—Ç–∏ –¥–æ 18, –Ω–µ –≤–∫–ª—é—á–∞—è 18
    if age <= 25:
        return "18-25"
    if age <= 35:
        return "25-35"
    if age <= 45:
        return "35-45"
    if age <= 55:
        return "45-55"
    return "55+"

def normalize_gender_label(g: str) -> str:
    """–ü—Ä–∏–≤–æ–¥–∏–º –ª—é–±—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã '–º—É–∂—á–∏–Ω–∞/–º—É–∂—á–∏–Ω—ã' –∏ '–∂–µ–Ω—â–∏–Ω–∞/–∂–µ–Ω—â–∏–Ω—ã' –∫ —Ñ–æ—Ä–º–∞–º –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ."""
    g = (g or "").strip().lower()
    if g.startswith("–º—É–∂"):   # '–º—É–∂—á–∏–Ω–∞', '–º—É–∂', '–º—É–∂—á–∏–Ω—ã' ‚Äî –≤—Å—ë —Å—é–¥–∞
        return "–ú—É–∂—á–∏–Ω—ã"
    return "–ñ–µ–Ω—â–∏–Ω—ã"          # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º '–∂–µ–Ω—â–∏–Ω—ã/–∂–µ–Ω—â–∏–Ω–∞'

def cohort(gender: str, age: float) -> str:
    return "–î–µ—Ç–∏" if age_band(age) == "0-18" else normalize_gender_label(gender)

def class_by_budget_rub(budget: float) -> str:
    # <100k ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ; 100‚Äì229999: 3; 230‚Äì499999: 2; >=500k: 1
    if budget < 100_000:
        return "–í—ã –±—ã –Ω–µ —Å–º–æ–≥–ª–∏ –∫—É–ø–∏—Ç—å –±–∏–ª–µ—Ç –Ω–∞ –¢–∏—Ç–∞–Ω–∏–∫"
    if budget < 230_000:
        return "3"
    if budget < 499_000:
        return "2"
    return "1"

# ===== UI =====
st.title("üö¢ –í—ã–∂–∏–ª–∏ –±—ã –≤—ã –Ω–∞ –¢–∏—Ç–∞–Ω–∏–∫–µ?")
st.caption("–°—á–∏—Ç–∞–µ–º –ø–æ –ø–æ–ª—É, –≤–æ–∑—Ä–∞—Å—Ç—É –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –±–∏–ª–µ—Ç–∞.")

with st.sidebar:
    st.header("–í–≤–æ–¥")
    # –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å '–ñ–µ–Ω—â–∏–Ω—ã/–ú—É–∂—á–∏–Ω—ã' –∏–ª–∏ '–ñ–µ–Ω—â–∏–Ω–∞/–ú—É–∂—á–∏–Ω–∞' ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å—ë –ø–æ–ø—Ä–∞–≤–∏—Ç
    gender = st.selectbox("–ü–æ–ª", ["–ñ–µ–Ω—â–∏–Ω–∞", "–ú—É–∂—á–∏–Ω–∞"])
    age = st.number_input("–í–æ–∑—Ä–∞—Å—Ç (–ø–æ–ª–Ω—ã—Ö –ª–µ—Ç)", min_value=0, max_value=110, value=25, step=1)
    budget = st.number_input("–°–∫–æ–ª—å–∫–æ –±—ã –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –Ω–∞ –±–∏–ª–µ—Ç (–≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—É–±–ª—è—Ö)", min_value=0, value=250_000, step=10_000, format="%i")

band = age_band(age)
coh = cohort(gender, age)
klass = class_by_budget_rub(budget)

st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç")
col1, col2, col3 = st.columns(3)

# –ï—Å–ª–∏ –∫–ª–∞—Å—Å ‚Äî —Ç–µ–∫—Å—Ç –ø—Ä–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∏–ª–µ—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫—É –∫–æ—Ä–æ—Ç–∫–æ –∏ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
if klass in {"1", "2", "3"}:
    class_display = klass
    no_ticket_msg = None
else:
    class_display = "‚Äî"
    no_ticket_msg = klass

col1.metric("–ö–æ–≥–æ—Ä—Ç–∞", coh)
col2.metric("–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω", band)
col3.metric("–ö–ª–∞—Å—Å –ø–æ –±—é–¥–∂–µ—Ç—É", class_display)

if no_ticket_msg:
    st.warning(no_ticket_msg)

# –ü–æ–∏—Å–∫ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
coef_text = "N/A"
coef_val = None
if klass in {"1", "2", "3"}:
    row = df[(df["Cohort"] == coh) & (df["AgeBand"] == band) & (df["Class"] == int(klass))]
    if not row.empty:
        coef_val = float(row["SurvivalCoef"].iloc[0])
        coef_text = f"{coef_val*100:.1f}%"
    else:
        coef_text = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
elif no_ticket_msg:
    coef_text = "0.0%"  # –ù–µ—Ç –±–∏–ª–µ—Ç–∞ ‚Üí 0%

st.markdown(f"### –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏–≤–∞–Ω–∏—è: **{coef_text}**")
if coef_val is not None:
    st.progress(min(max(coef_val, 0.0), 1.0))

with st.expander("–ü–æ—è—Å–Ω–µ–Ω–∏–µ"):
    st.write(
        "1) –í–≤–æ–¥: –ø–æ–ª, –≤–æ–∑—Ä–∞—Å—Ç –∏ –±—é–¥–∂–µ—Ç –≤ —Ä—É–±–ª—è—Ö.\n"
        "2) –ö–ª–∞—Å—Å –ø–æ –ø–æ—Ä–æ–≥–∞–º: 3 –∫–ª. 100‚Äì230 —Ç—ã—Å., 2 –∫–ª. 230‚Äì499 —Ç—ã—Å., 1 –∫–ª. ‚â•500 —Ç—ã—Å.\n"
        "3) –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏–≤–∞–Ω–∏—è —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –¥–æ–ª–∏ –≤—ã–∂–∏–≤—à–∏—Ö –≤ –∫–∞–∂–¥–æ–º –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–ª–∞—Å—Å–∞ –±–∏–ª–µ—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –¥–æ–ª—è ‚Äî 0,9, —Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤—ã–∂–∏–≤–∞–Ω–∏—è ‚Äî 90%."
    )

# –¢–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ (–≤–∫–ª—é—á–∞—é—Ç—Å—è —Ñ–ª–∞–≥–æ–º —Å–≤–µ—Ä—Ö—É)
if SHOW_TESTS:
    st.subheader("–¢–µ—Å—Ç—ã")
    colA, colB, colC = st.columns(3)
    with colA:
        if st.button("–ñ–µ–Ω—â–∏–Ω–∞, 22 –≥., 150k ‚ÇΩ ‚Üí 50.0%"):
            st.session_state["gender"] = "–ñ–µ–Ω—â–∏–Ω–∞"
            st.session_state["age"] = 22
            st.session_state["budget"] = 150_000
            st.experimental_rerun()
    with colB:
        if st.button("–ñ–µ–Ω—â–∏–Ω–∞, 30 –ª., 250k ‚ÇΩ ‚Üí 92.3%"):
            st.session_state["gender"] = "–ñ–µ–Ω—â–∏–Ω–∞"
            st.session_state["age"] = 30
            st.session_state["budget"] = 250_000
            st.experimental_rerun()
    with colC:
        if st.button("–ú—É–∂—á–∏–Ω–∞, 28 –ª., 520k ‚ÇΩ ‚Üí 55.0%"):
            st.session_state["gender"] = "–ú—É–∂—á–∏–Ω–∞"
            st.session_state["age"] = 28
            st.session_state["budget"] = 520_000
            st.experimental_rerun()


# ===== –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç =====
st.markdown("---")  # —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
st.markdown(
    """
    <div style="background-color:#f8fafc; padding:25px 30px; border-radius:12px; border:1px solid #e2e8f0;">
    <h2 style="margin-top:0;">–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</h2>

    <p>–í –Ω–æ—á—å –Ω–∞ 15 –∞–ø—Ä–µ–ª—è 1912 –≥–æ–¥–∞ –∫—Ä—É–ø–Ω–µ–π—à–∏–π –Ω–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç –æ–∫–µ–∞–Ω—Å–∫–∏–π –ª–∞–π–Ω–µ—Ä <b>¬´–¢–∏—Ç–∞–Ω–∏–∫¬ª</b> —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –∞–π—Å–±–µ—Ä–≥–æ–º 
    –∏ –∑–∞—Ç–æ–Ω—É–ª –≤ —Ö–æ–ª–æ–¥–Ω—ã—Ö –≤–æ–¥–∞—Ö –ê—Ç–ª–∞–Ω—Ç–∏–∫–∏. –ù–∞ –±–æ—Ä—Ç—É –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –±–æ–ª–µ–µ <b>2200 —á–µ–ª–æ–≤–µ–∫</b>, –Ω–æ –≤—ã–∂–∏–ª–∞ –ª–∏—à—å —Ç—Ä–µ—Ç—å.</p>

    <p>–ñ–µ—Ä—Ç–≤—ã –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—ã —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–ª–∏—Å—å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ. <i>¬´–¢–∏—Ç–∞–Ω–∏–∫¬ª</i> –±—ã–ª –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–æ—Ä–∞–±–ª—ë–º¬†‚Äî 
    –æ–Ω –æ—Ç—Ä–∞–∂–∞–ª —Å–æ—Ü–∏–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±—â–µ—Å—Ç–≤–∞ –Ω–∞—á–∞–ª–∞ XX –≤–µ–∫–∞.</p>

    <p><b>–ü–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å</b> ‚Äî –±–æ–≥–∞—Ç–µ–π—à–∏–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã: –ø—Ä–æ—Å—Ç–æ—Ä–Ω—ã–µ –∫–∞—é—Ç—ã, —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –¥–æ—Å—Ç—É–ø –∫ —à–ª—é–ø–∫–∞–º –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å. 
    –ú–µ–¥–∏–∞–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞ ‚Äî <b>92 —Ñ—É–Ω—Ç–∞ —Å—Ç–µ—Ä–ª–∏–Ω–≥–∞</b>, —á—Ç–æ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ <b>14,5 —Ç—ã—Å. —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–ª–ª–∞—Ä–æ–≤</b> 
    –∏–ª–∏ —á—É—Ç—å –±–æ–ª—å—à–µ <b>1 –º–ª–Ω —Ä—É–±–ª–µ–π</b>.</p>

    <p><b>–í—Ç–æ—Ä–æ–π –∫–ª–∞—Å—Å</b> ‚Äî —Å—Ä–µ–¥–Ω–∏–π –∫–ª–∞—Å—Å: —É—á–∏—Ç–µ–ª—è, –∫–ª–µ—Ä–∫–∏, —ç–º–∏–≥—Ä–∞–Ω—Ç—ã —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º–∏. 
    –í —Å—Ä–µ–¥–Ω–µ–º –∑–∞ –±–∏–ª–µ—Ç –≤—Ç–æ—Ä–æ–≥–æ –∫–ª–∞—Å—Å–∞ –Ω—É–∂–Ω–æ –±—ã–ª–æ –æ—Ç–¥–∞—Ç—å <b>20 —Ñ—É–Ω—Ç–æ–≤</b> 
    (–æ–∫–æ–ª–æ <b>3,2 —Ç—ã—Å. —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–ª–ª–∞—Ä–æ–≤</b> –∏–ª–∏ <b>250 —Ç—ã—Å. —Ä—É–±–ª–µ–π</b>).</p>

    <p><b>–¢—Ä–µ—Ç–∏–π –∫–ª–∞—Å—Å</b> ‚Äî –±–µ–¥–Ω–µ–π—à–∏–µ –ø–µ—Ä–µ—Å–µ–ª–µ–Ω—Ü—ã, —Å—Ç—Ä–µ–º–∏–≤—à–∏–µ—Å—è –≤ –ù–æ–≤—ã–π –°–≤–µ—Ç; 
    –∏—Ö –∫–∞—é—Ç—ã –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –≤–Ω–∏–∑—É, –≤—ã—Ö–æ–¥—ã –±—ã–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã. 
    –ë–∏–ª–µ—Ç –º–æ–∂–Ω–æ –±—ã–ª–æ –∫—É–ø–∏—Ç—å –∑–∞ <b>12 —Ñ—É–Ω—Ç–æ–≤</b>, —á—Ç–æ –≤ –ø–µ—Ä–µ—Å—á—ë—Ç–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–ª–ª–∞—Ä—ã —Å–æ—Å—Ç–∞–≤–∏–ª–æ –±—ã 
    –ø—Ä–∏–º–µ—Ä–Ω–æ <b>1 750</b>, –∞ –Ω–∞ —Ä—É–±–ª–∏ ‚Äî <b>140 —Ç—ã—Å.</b></p>

    <p>–¢–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–æ –Ω–µ–≥–ª–∞—Å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ: <i>¬´–∂–µ–Ω—â–∏–Ω—ã –∏ –¥–µ—Ç–∏ ‚Äî –ø–µ—Ä–≤—ã–º–∏ –≤ —à–ª—é–ø–∫–∏¬ª</i>. 
    –ù–æ –¥–∞–∂–µ –æ–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–ª–∞—Å—Å–∞. 
    <b>–ñ–µ–Ω—â–∏–Ω–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞</b> –∏–º–µ–ª–∞ –ø–æ—á—Ç–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–Ω—Å—ã –≤—ã–∂–∏—Ç—å, 
    —Ç–æ–≥–¥–∞ –∫–∞–∫ <b>–º—É–∂—á–∏–Ω–∞ –∏–∑ —Ç—Ä–µ—Ç—å–µ–≥–æ</b> ‚Äî –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–∞–∫–∏–µ.</p>
    </div>
    """,
    unsafe_allow_html=True
)
